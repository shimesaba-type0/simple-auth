# Simple Auth - 多段認証サーバー 仕様書

## 概要

nginx の auth_request に対応した、多段認証サーバーです。

### ユーザー登録

**招待制**を採用しています。管理者が発行した招待リンクからのみユーザー登録が可能です。

- 管理者が招待リンクを作成（最大使用回数、有効期限を設定可能）
- 招待リンクは複数回使用可能（例: 10人分の招待リンク）
- ユーザーはメールアドレスを入力するだけで登録完了
- パスフレーズはサーバー側で自動生成（64文字以上、英数字のみ）
- パスフレーズは登録時に1回だけ表示（パスワードマネージャーに保存必須）

### 認証方式

1. **第1段階**: 事前共有パスフレーズ（64文字以上、英数字のみ）
2. **第2段階**: メールアドレスでのOTP（ワンタイムパスワード）

### 主な機能

- **招待制ユーザー登録** - 管理者が発行した招待リンクからのみ登録可能
- ユーザー認証（2FA）
- **SSO（Single Sign-On）** - 1回のログインで複数サービスにアクセス
- カスタマイズ可能なダッシュボード
- nginx auth_request 連携
- ユーザー管理（管理者機能）
- 招待リンク管理（作成、無効化、使用状況追跡）
- fail lock機能（ブルートフォース対策）
- 通知機能（管理者通知・個人通知）

## アーキテクチャ：認証ゲートウェイとしてのSSO

この認証サーバーは、複数のバックエンドサービスを保護する**認証ゲートウェイ**として機能します。

```
[ユーザー]
    ↓ (1回だけログイン)
[認証サーバー]
    ├→ [バックエンドサービスA]
    ├→ [バックエンドサービスB]
    └→ [バックエンドサービスC]
```

### 特徴

✅ **1回のログインで全サービスにアクセス** - ユーザーは認証サーバーに1回だけログインすれば、すべてのバックエンドサービスを利用可能
✅ **疎結合** - バックエンドサービスは認証ロジックを持たず、X-Auth-Userヘッダーを受け取るだけ
✅ **一元管理** - ユーザー管理、監査ログ、セキュリティポリシーが1箇所に集約
✅ **スケーラブル** - 新しいサービスを追加してもnginx設定を増やすだけ

### ユースケース

- 社内システム（複数の業務アプリケーション）の統一認証
- マイクロサービスアーキテクチャの認証基盤
- 既存OSSの前段に配置して認証を追加

## ドキュメント構成

### コア機能
- [認証フロー](./authentication-flow.md) - 認証の詳細仕様
- [一般ユーザー機能](./user-features.md) - 一般ユーザーができること
- [管理者機能](./admin-features.md) - 管理者ができること
- [nginx連携](./nginx-integration.md) - nginx auth_request の統合方法（SSO対応）
- [セキュリティ](./security.md) - セキュリティ要件と対策

### 技術仕様
- [データベース設計](./database-schema.md) - SQLite3 スキーマ（Redis はオプション）
- [API仕様](./api-specification.md) - REST API エンドポイント
- [技術スタック](./technology-stack.md) - Go + SQLite3（+ Redis オプション）

### オプション機能
- [サブスクリプション・課金](./subscription-billing.md) - 課金機能の設計（将来的な拡張）

## 設計思想

- **招待制**: 管理者が承認したユーザーのみが登録可能（セキュアなオンボーディング）
- **パスワードマネージャー前提**: 64文字以上のパスフレーズは、パスワードマネージャーで管理することを想定
- **セキュリティ重視**: fail lock、レート制限、監査ログ、招待リンクの有効期限管理など
- **シンプル優先**: SQLite3のみで動作（小〜中規模向け）、大規模化したらRedis追加可能
- **柔軟性**: ユーザーごとにカスタマイズ可能なダッシュボード
- **運用しやすさ**: 招待リンクの複数回使用により、一度に複数ユーザーを招待可能

## 規模別の構成選択

### 構成1: SQLite3のみ（デフォルト・推奨）

**対象:**
- 👥 **ユーザー数**: 〜500人
- 🔄 **同時接続**: 〜50人
- 📊 **auth_request**: 〜500リクエスト/秒
- 💻 **サーバースペック**: 2コア、4GB RAM

**メリット:**
- ✅ セットアップが簡単（ファイル1つ）
- ✅ 依存関係なし（Redisサーバー不要）
- ✅ 運用コストが低い
- ✅ バックアップが簡単（DBファイルをコピーするだけ）

**ユースケース:**
- 社内システム（数十〜数百人規模）
- スタートアップのMVP
- 個人プロジェクト
- 中小企業の認証基盤

### 構成2: SQLite3 + Redis（大規模向け）

**対象:**
- 👥 **ユーザー数**: 500〜10,000人
- 🔄 **同時接続**: 50〜500人
- 📊 **auth_request**: 500〜5,000リクエスト/秒
- 💻 **サーバースペック**: 4コア以上、8GB RAM以上

**メリット:**
- ✅ auth_requestが超高速（Redisキャッシュ）
- ✅ セッション管理がスケーラブル
- ✅ TTL自動管理（期限切れデータが自動削除）

**追加コスト:**
- ❌ Redisサーバーの運用
- ❌ 学習コスト（Redis知識）
- ❌ Docker構成が複雑化

**移行タイミング:**
- auth_requestのレスポンスが遅くなってきた（50ms以上）
- 同時接続数が増えてきた（100人以上）
- セッション数が多すぎてSQLite3で管理しきれない

### パフォーマンス比較

| 項目 | SQLite3のみ | SQLite3 + Redis |
|------|------------|----------------|
| **auth_request応答** | 5-20ms | 1-5ms |
| **セッション読み取り** | 高速 | 超高速 |
| **セッション書き込み** | 同時1つまで | 制限なし |
| **スケール限界** | 〜500同時ユーザー | 数千〜数万 |
| **セットアップ** | 簡単 | やや複雑 |
| **運用コスト** | 低い | 中程度 |

### 推奨アプローチ

**Phase 1: SQLite3のみでスタート（推奨）**
```
まずはSQLite3だけで実装・運用
→ シンプルで学習コストが低い
→ ほとんどのケースで十分なパフォーマンス
```

**Phase 2: 必要になったらRedis追加**
```
パフォーマンス問題が出たら、後からRedisを追加
→ コードの変更は最小限（設定ファイルの追加程度）
→ 段階的なスケールアップが可能
```
